function mm(a,b,c){return Math.max(a,Math.min(b,c))}!function(){for(var a,b=function(){},c=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],d=c.length,e=window.console=window.console||{};d--;)a=c[d],e[a]||(e[a]=b)}(),require(["jquery"],function(a){a.fn.share=function(b){if(!this.find(".sn-share-btns").length){var c={trigger:"hover",duration:"fast",text:void 0,url:"http://vempraruavem.org"},b=_.extend(_.extend(c,this.data()),b),d={twitter:function(){if(!b.text&&!b.url)throw"No url or text specified";var a="http://twitter.com/share?"+(b.text&&"&text="+encodeURIComponent(b.text))||"url="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")},facebook:function(){if(!b.url)throw"No url or text specified";var a="http://www.facebook.com/sharer.php?u="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")},gplus:function(){if(!b.url)throw"No url or text specified";var a="https://plusone.google.com/_/+1/confirm?hl=pt&url="+encodeURIComponent(b.url);window.open(a,"","width=500,height=350,toolbar=0,menubar=0,location=0","modal=yes")}};this.addClass("sn-share");var e=a('<div class="sn-share-btns"><div class="btn-group"><button class="btn btn-xs btn-info btn-twitter"><i class="fa fa-twitter"></i></button><button class="btn btn-xs btn-info btn-facebook">&nbsp;<i class="fa fa-facebook"></i>&nbsp;</button><button class="btn btn-xs btn-info btn-gplus"><i class="fa fa-google-plus"></i></button></div><div class="arrow"></div></div>');e.find(".btn-twitter").click(d.twitter),e.find(".btn-facebook").click(d.facebook),e.find(".btn-gplus").click(d.gplus),e.appendTo(this),this.click(function(a){return a.stopPropagation(),a.preventDefault(),!1}),b.now===!0?(e.fadeIn(),this.on("click "+("hover"===b.trigger?"mouseenter":""),function(){e.fadeIn(b.duration)})):this.on("click "+("hover"===b.trigger?"mouseenter":""),function(){e.fadeIn(b.duration)}),this.on("mouseleave",function(){e.fadeOut(b.duration)})}}}),Date.prototype.addDays=function(a){var b=new Date(this.valueOf());return b.setDate(b.getDate()+a),b},Date.prototype.sameDate=function(a){return this.getDate()==a.getDate()&&this.getMonth()==a.getMonth()&&this.getYear()==a.getYear()},Date.prototype.slashed=function(){return""+this.getDate()+"/"+(this.getMonth()+1)+"/"+this.getFullYear()},Date.prototype.colon=function(){return""+this.getHours()+":"+(this.getMinutes()||"00")},require(["jquery","backbone","underscore","handlebars","bootstrap"],function(a,b,c,d){function e(b){function c(){var c=b.target;a(c).stop(),a(c).find("label.control-label").html("Quer adicionar um evento ao nosso mapa?"),a(c).find(">button").unbind("click"),c.classList.remove("has-error"),c.classList.remove("has-success"),c.classList.remove("has-warning"),a(c).find(">button").html('<i class="fa fa-check"></i>').addClass("wow").removeClass("bad")}b.preventDefault();var d=b.target,e=d.querySelector("input[type=text]"),f=/(?:events)?\/(\d+)\/?/g.exec(e.value);if(a(e).bind("keydown",function(a){27===a.keyCode&&(c(),d.classList.add("hid"))}),!e.value||""==e.value)return d.classList.add("has-warning"),void 0;if(!f||f.length<2)var g=e.value;else var g=f[1];c(),console.log("Id extracted:",g),a(d).find(">button").html('<i class="fa fa-spinner fa-spin"></i>'),a.ajax({url:"/api/events",type:"put",data:{id:g},dataType:"json",success:function(b){console.log("Put request to /api/events was successful",arguments),d.classList.add("has-success"),app._raw_events.push(b),app.eventList.reset(app._raw_events),b.isNew?(app.eventListView.render(app.eventList.toJSON()),a("#countNotice count").html(app.eventList.length),a(d).find("label.control-label").html("Sucesso! Evento adicionado. :)")):a(d).find("label.control-label").html("Esse evento já foi adicionado. :O"),app.goToEvent(b.id,!0),setTimeout(function(){e.value="",app.eventAdder.hide(),c()},1500)},error:function(b){var f=JSON.parse(b.responseText),g=f.message||"Algum erro ocorreu.";a(d).find("label.control-label").html("Ops! "+g),console.log(b.responseText),a(d).find(">button").click(function(a){a.preventDefault(),e.value="",c()}),a(e).bind("keydown change",function(){c()}),d.classList.add("has-error"),a(d).find(">button").html('<i class="fa fa-times"></i>')}})}function f(){a("body").width()<770?a("#map-wrapper").height(a(document.body).height()-93):a("body").height()<600?a("#map-wrapper").height(a(document.body).height()-40-2):a("#map-wrapper").height(a(document.body).height()-40)}Handlebars.registerHelper("loop",function(a,b){var c="";for(a=Math.max(0,a);a--;)c+=b.fn();return c});var g=b.View.extend({btn:a("<div>"),constructor:function(){var a=this;this.btn.click(function(b){b.preventDefault(),a.toggle()}),b.View.apply(this,arguments),this.$el.on("click","[data-action=exit]",function(){a.hide()})},show:function(){this.$el.fadeIn(),this.btn.addClass("active")},hide:function(){this.$el.fadeOut(),this.btn.removeClass("active")},toggle:function(){this.$el.fadeToggle(),this.btn.toggleClass("active")}}),h=b.Model.extend({initialize:function(){}}),i=b.Collection.extend({model:h,url:"/api/ninjas",comparator:"live_viewers_count"}),j=b.Model.extend({initialize:function(){},getLatLng:function(){return new google.maps.LatLng(this.get("lat"),this.get("lng"))},parse:function(){var a=b.Model.prototype.parse.apply(this,arguments);return a.lat+=(Math.random()-Math.random())/5e3,a.lng+=(Math.random()-Math.random())/1e4,a}}),k=b.Collection.extend({model:j,comparator:"start_time",url:"/api/events"}),l=b.View.extend({closeInfoWindow:function(){this.infowindow.close()},openInfoWindow:function(){this.infowindow.open(app.map,this.marker)},destroy:function(){this.marker.setMap(null),this.infowindow.setMap(null),this.marker=this.infowindow=null,this.undelegateEvents(),this.$el.removeData().unbind(),this.unbind(),this.remove()}}),m=l.extend({infowindowTemplate:d.compile(a("#ninja-infowindow-template").html()),initialize:function(){this.listenTo(this.model.collection,"reset",this.destroy),this.marker=new google.maps.Marker,google.maps.event.addListener(this.marker,"click",c.bind(this.click,this));var a,b=new Date-new Date(this.model.get("lastSave"));a=6e4>b?"menos de um minuto":""+Math.round(b/6e4)+" minuto"+(b>=12e4?"s":""),this.infowindow=new google.maps.InfoWindow({maxWidth:400,content:this.infowindowTemplate(c.extend(this.model.toJSON(),{vprv_link:"http://vempraruavem.org#ninjas/"+encodeURIComponent(this.model.get("id")),lastSaveF:a,live_viewers_count:this.model.get("live_viewers_count")||0}))}),google.maps.event.addListener(this.infowindow,"closeclick",app.unselectAll.bind(app))},click:function(){app.mapsNinjasView.closeInfoWindows(),app.mapsEventsView.closeInfoWindows(),this.infowindow.open(app.map,this.marker),app.goToNinja(this.model.get("id"))},render:function(){var a="static/img/cam1.png";return this.marker.setOptions({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),animation:google.maps.Animation.DROP,icon:a}),this.marker}}),n=l.extend({infowindowTemplate:d.compile(a("#event-infowindow-template").html()),initialize:function(){this.listenTo(this.model.collection,"reset",this.destroy),this.circle=new google.maps.Circle,this.marker=new google.maps.Marker({position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng"))}),this.infowindow=new google.maps.InfoWindow({maxWidth:400,content:this.infowindowTemplate({id:this.model.get("id"),name:this.model.get("name").length>100?this.model.get("name").slice(0,100)+"...":this.model.get("name"),date:new Date(this.model.get("start_time")).slashed(),time:new Date(this.model.get("start_time")).colon(),location:this.model.get("location"),count:{num:this.model.get("count"),sub:this.model.get("count")>1e4?"Tá indo gente pra dédéu!":"",rank:mm(0,Math.floor(Math.log(this.model.get("count"))/2),7)},description:this.model.get("description").split(" ").slice(0,20).join(" "),reviewed:this.model.get("reviewed"),facebookUrl:this.model.get("facebookUrl"),url:this.model.get("url")})}),this.emphasized=!1,google.maps.event.addListener(this.circle,"click",c.bind(this.click,this)),google.maps.event.addListener(this.marker,"click",c.bind(this.click,this)),google.maps.event.addListener(this.infowindow,"closeclick",app.unselectAll.bind(app))},openInfoWindow:function(){app.map.getZoom()>13?this.infowindow.open(app.map,this.marker):this.infowindow.open(app.map,this.circle)},destroy:function(){this.marker.setMap(null),this.circle&&this.circle.setMap(null),this.infowindow.setMap(null),this.marker=this.infowindow=null,this.undelegateEvents(),this.$el.removeData().unbind(),this.unbind(),this.remove()},getRadiusFromCount:function(a){var b=app.map.getZoom(),c=Math.pow(2,mm(0,b-10,10)),d=1128.497*Math.pow(2,20-b),e=mm(10,Math.sqrt(a),200);return d*c*e*5e-5},click:function(){app.mapsNinjasView.closeInfoWindows(),app.mapsEventsView.closeInfoWindows(),this.infowindow.open(app.map,app.map.getZoom()>13?this.marker:this.circle),app.goToEvent(this.model.get("id"))},render:function(){if(app.map.getZoom()>13)return this.infowindow.getMap()&&this.infowindow.setAnchor(this.marker),this.marker.setMap(app.map),this.marker.setVisible(!0),this.circle.setVisible(!1),this.marker;this.infowindow.getMap()&&this.infowindow.setAnchor(this.circle),this.marker.setVisible(!1),this.circle.setMap(app.map);var a=this.model.get("isUserInput")?"#2980b9":"#2ecc71";if(this.model.get("count")>2e3)var a="#e74c3c";else if(this.model.get("count")>1e4)var a="#c0392b";return this.circle.setOptions({visible:!0,fillColor:a,fillOpacity:this.emphasized?1:.8,strokeColor:"black",strokeWeight:1*(this.emphasized?2:1),radius:this.getRadiusFromCount(this.model.get("count"))*(this.emphasized?1:1),zIndex:this.emphasized?1:-this.model.get("count"),center:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng")),position:new google.maps.LatLng(this.model.get("lat"),this.model.get("lng"))}),this.circle}}),o=b.View.extend({_views:[],viewModel:null,initialize:function(){this.map=app.map,this.bindToMaps(this.map),this.collection.on("reset",this.render,this),app.date.on("change:date",this.onDateChanged,this)},showView:function(a){this.closeInfoWindows();for(var b=0;b<this._views.length;b++)if(this._views[b].model.get("id")===a.get("id")){this._views[b].openInfoWindow();break}},render:function(){this._views=[];return this.collection.each(function(a){var b=new this.viewModel({model:a});this._views.push(b),b.render().setMap(this.map)},this),this},closeInfoWindows:function(){c.each(this._views,function(a){a.closeInfoWindow()})},bindToMaps:function(a){var b=this;google.maps.event.addListener(a,"zoom_changed",function(){c.each(b._views,function(a){a.render()})})},onDateChanged:function(){}}),p=o.extend({viewModel:n}),q=o.extend({viewModel:m}),r=b.View.extend({tagName:"li",template:Handlebars.compile(a("#event-template").html()),events:{click:"click"},initialize:function(){this.prender()},click:function(){app.goToEvent(this.model.get("id"),!0)},prender:function(){return this.$el.html(this.template({name:this.model.get("name"),count:this.model.get("count"),description:this.model.get("description").split(" ").slice(0,10).join(" "),date:new Date(this.model.get("start_time")).slashed(),time:new Date(this.model.get("start_time")).colon(),count:{num:this.model.get("count"),rank:mm(0,Math.floor(Math.log(this.model.get("count"))/2),7)},location:this.model.get("location"),reviewed:this.model.get("reviewed"),link:this.model.get("facebookUrl"),sub:this.model.get("count")>1e4?"Tá indo gente pra dédéu!":""})),this.el.dataset.id=this.model.get("id"),this.delegateEvents(),this},eventWithinBounds:function(){var a=app.map.getBounds();return a&&!a.contains(this.model.getLatLng())?!1:!0}}),s=g.extend({events:{},_views:[],el:a("#event-list")[0],btn:a("#nav-event-list"),initialize:function(){this.collection.on("reset",this.prender,this),this.collection.on("add",this.prender,this),this.prender(),google.maps.event.addListener(app.map,"zoom_changed",this.render.bind(this)),google.maps.event.addListener(app.map,"center_changed",this.render.bind(this))},prender:function(){return this._views=[],this.collection.each(function(a){this._views.push(new r({model:a}))},this),this.render()},render:function(){var b=document.createDocumentFragment();if(c.isEmpty(this._views))a(b).append("<li>Não há eventos listados para esse dia.</li>");else{for(var d=0;d<this._views.length;d++){var e=this._views[d];e.eventWithinBounds()?(e.delegateEvents(),e.$el.appendTo(b)):e.remove()}0===b.childElementCount&&a(b).append("<li>Não há eventos visiveis nessa área do mapa.</li>")}this.$el.empty().append(b)}}),t=g.extend({btn:a("#nav-add-event"),el:a("#add-event"),initialize:function(){a("#add-event form").bind("submit",e)}}),u=g.extend({el:a("#calendar"),btn:a("#calendar-icon"),initialize:function(){this.model.on("change",this.render,this),this.model.on("reset",this.render,this),this.render()},render:function(){function b(b){var c=document.createElement("td");c.dataset.date=b.valueOf(),b<e.model.get("today")?c.classList.add("bygone"):b.sameDate(e.model.get("today"))?c.classList.add("today"):b.sameDate(e.model.get("currentDate"))&&c.classList.add("current"),c.innerHTML=b.getDate();var f=a('<div class="circles"></div>').appendTo(c),g=d[1*b];if(g)for(var h=0;h<g.length;h++)a("<span><i class='fa fa-circle-o'></i></span>").appendTo(f);return c}var c=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];a("[data-data]").html(c[(new Date).getMonth()]+" 2013");for(var d=app.eventList.groupBy(function(a){return new Date(a.get("start_time")).setHours(0,0,0,0)}),e=this,f=0,g=0,h=new Date(this.model.get("today").addDays(-this.model.get("today").getDay())),i=function(){var a=new Date(parseInt(this.dataset.date));a<e.model.get("today")||(a.sameDate(e.model.get("currentDate"))?app.selectDate(null):app.selectDate(a),e.hide())},j=document.createDocumentFragment();f++<5;){for(var k=document.createElement("tr");++g%8;){var l=b(h);k.appendChild(l),h=h.addDays(1),a(l).click(i)}j.appendChild(k)}return this.$el.find("table tbody").empty().append(j),this}}),v=b.View.extend({el:a("#date"),initialize:function(){this.model.on("change",this.render,this),this.model.on("reset",this.render,this),this.$el.click(function(){app.toggleBoundDate()}),this.render();a("#date-wrapper .arrow[data-action=down]").click(function(){app.moveCurrentDate(-1)}),a("#date-wrapper .arrow[data-action=up]").click(function(){app.moveCurrentDate(1)})},render:function(){return this.model.get("currentDate").sameDate(this.model.get("today"))?a("#date-wrapper").addClass("in-lower-bound"):a("#date-wrapper").removeClass("in-lower-bound"),this.model.changedAttributes().hasOwnProperty("dateBound")&&(this.model.get("dateBound")?(this.$el.addClass("date-bound"),a("#date").attr("title","Você só está vendo eventos desse dia. Clique para desabilitar essa função.").tooltip("fixTitle").tooltip("show")):(a("#date").attr("title","Clique aqui para ver apenas os eventos desde dia.").tooltip("fixTitle").tooltip("show"),this.$el.removeClass("date-bound"))),this.$el.find("[data-piece=day]").html((day=this.model.get("currentDate").getDate())<10?"0"+day:day),this.$el.find("[data-piece=month]").html(this.model.get("currentDate").getMonth()+1),this.$el.find("[data-piece=year]").html((""+this.model.get("currentDate").getFullYear()).slice(0,4)),this}}),w=b.Model.extend({defaults:{today:new Date((new Date).setHours(0,0,0,0)),currentDate:new Date((new Date).setHours(0,0,0,0)),dateBound:!1},initialize:function(){},updateCurrentDate:function(a){this.set("dateBound",!0),this.set("currentDate",new Date(null!==a?Math.max(a.valueOf(),this.get("today").valueOf()):this.get("today").valueOf()))},toggleBoundDate:function(){this.set("dateBound",!this.get("dateBound"))},moveCurrentDate:function(a){"number"==typeof a?this.updateCurrentDate(new Date(this.get("currentDate")).addDays(a)):a instanceof Date?this.set("currentDate",a):(alert(1),this.set("currentDate",today))}});f(),a(window).resize(f),window.app=new(b.Router.extend({geoLocate:function(){var a=this;navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(b){var c=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);a.map.setCenter(c)})},initialize:function(){this.map=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(-14.656,-52.09),zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),this.geoLocate(),a("[data-action=geolocate]").click(c.bind(this.geoLocate,this,9)),this.date=new w,this.eventList=new k,this.ninjaList=new i,this.route("events/:id","events",function(a){console.log(arguments),a=a.replace(/(^\s+|\s+$)/g,"");var b=this.eventList.findWhere({id:parseInt(a)});b?(this.mapsNinjasView.closeInfoWindows(),this.map.setOptions({center:new google.maps.LatLng(b.get("lat"),b.get("lng")),zoom:15}),this.eventListView.prender(),this.mapsEventsView.showView(b)):(alert("Esse evento não está mais no mapa. Será que ele ainda existe?"),this.navigate("/"))}),this.route("ninjas/:id","ninjas",function(a){a=a.replace(/(^\s+|\s+$)/g,"");var b=this.ninjaList.findWhere({id:a});b?(this.mapsEventsView.closeInfoWindows(),this.map.setOptions({center:new google.maps.LatLng(b.get("lat"),b.get("lng")),zoom:15}),this.mapsNinjasView.showView(b)):(alert("Esse ninja ficou invisível. Será que ele está offline?"),this.navigate("/"))})},goToNinja:function(a,b){this.navigate("/ninjas/"+a,{trigger:b||!1})},goToEvent:function(a,b){this.navigate("/events/"+a,{trigger:b||!1})},unselectAll:function(){this.navigate("/")},start:function(){this.eventListView=new s({collection:this.eventList}),this.mapsEventsView=new p({collection:this.eventList}),this.mapsNinjasView=new q({collection:this.ninjaList}),this.calendarView=new u({model:this.date}),this.dateDisplayView=new v({model:this.date}),this.eventAdder=new t,this.eventList.on("reset",this.calendarView.render,this.calendarView);var a=this;this.date.on("change",function(){a.date.get("dateBound")?a.eventList.reset(c.filter(a._raw_events,function(b){return a.date.get("currentDate").sameDate(new Date(b.start_time))},a)):a.eventList.reset(a._raw_events.slice())}),this._raw_events=this._raw_ninjas=[];var d=2;this.eventList.once("reset",function(){a._raw_events=this.toJSON(),--d||b.history.start({pushState:!1})}),this.ninjaList.once("reset",function(){a._raw_ninjas=this.toJSON(),--d||b.history.start({pushState:!1})}),this.eventList.fetch({reset:!0}),this.ninjaList.fetch({reset:!0})},selectDate:function(a){return"undefined"==typeof a?(this.selectDate(this.date.get("currentDate")),void 0):(this.date.updateCurrentDate(a),void 0)},unselectDate:function(){this.date.set("dateBound",!1)},toggleBoundDate:function(){this.date.get("dateBound")?this.unselectDate():this.selectDate(void 0)},moveCurrentDate:function(a){this.selectDate(new Date(this.date.get("currentDate").addDays(a)))}})),app.start(),a(document).keyup(function(b){27===b.keyCode&&a("#add-event").is(":visible")&&a("#add-event").fadeOut()})});